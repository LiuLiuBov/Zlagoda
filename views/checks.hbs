<head>

    <link rel="stylesheet" href="/checks.css">
</head>

<body>

    <div class="container" id="more" onclick="myFunction(this)">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
    </div>

    <div id="settings">

        <form action="/checks" method="POST">
            <div class="column">
                {{#if iscashier}}
                <div>
                    <a href="/checks/add" class="btn btn-primary" id="addcheck">Add check</a>
                </div>
                {{/if}}
                <input type="text" id="searchnumber" name="searchnumber" class="form-control"
                    placeholder="Enter check number...">
                <span id="search_result"></span>
                <button class="btn btn-outline-secondary" type="submit">
                    <i class="fas fa-search"></i>
                </button>
                {{#if ismanager}}
                <div class="form-group">
                    <label for="searchbycategory">Search by cashier surname:</label>
                    <select id="searchbycategory" name="searchbycategory" class="form-control" required>
                        <option value="none"></option>
                        {{#each employees}}
                        <option value="{{this.id_employee}}"> {{this.empl_surname}}</option>
                        {{/each}}
                    </select>
                </div>
                <label for="searchbyprod">Product:</label>
                <select id="ssearchbyprod" name="searchbyprod" class="form-control" required>
                    <option value="none"></option>
                    {{#each products}}
                    <option value="{{this.id_product}}"> {{this.product_name}}</option>
                    {{/each}}
                </select>
                {{/if}}
                <div>
                    <label for="startDate">During the period:</label>
                </div>
                <div>
                    <input type="date" id="startDate" name="startDate">
                
                    <input type="date" id="endDate" name="endDate">
                </div>
                <div>
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div>
                    <p class="mt-3">Quantity of sold product: {{salesResults}}</p>
                </div>

        </form>
    </div>

    <script>
        function load_data(query = '') {
            fetch('/checks/get_data?search_query=' + query + '').then(function (res) {
                return res.json();
            }).then(function (responseData) {
                var html = '<ul class="list-group">';

                if (responseData.length > 0) {
                    for (var count = 0; count < responseData.length; count++) {
                        var regular_expression = new RegExp('(' + query + ')', 'gi');
                        html += '<a href="#" class="list-group-item list-group-item-action" onclick="get_text(this)">' + responseData[count].check_number.replace(regular_expression, '<span class="text-primary fw-bold">$1</span>') + '</a>';
                    }
                } else {
                    html += '<a href="#" class="list-group-item list-group-item-action disabled">Чеків не знайдено</a>';
                }

                html += '</ul>';

                document.getElementById('search_result').innerHTML = html;
                if (query === '') {
                    document.getElementById('search_result').style.display = 'none';
                } else {
                    document.getElementById('search_result').style.display = 'block';
                }
            });
        }

        var search_element = document.getElementById("searchnumber");

        search_element.onkeyup = function () {
            var query = search_element.value;
            load_data(query);
        };

        search_element.onfocus = function () {
            var query = search_element.value;
            load_data(query);
        };

        function get_text(event) {
            var check_number = event.textContent;
            console.log(product_name);
            document.getElementById('searchnumber').value = check_number;
            document.getElementById('search_result').innerHTML = '';
            document.getElementById('search_result').style.display = 'none';
        }
    </script>

    </div>
    <p class="mt-3">In total: <span id="totalAmount"></span></p>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Check number</th>
                    <th>Cashier surname</th>
                    <th>Date of creation</th>
                    <th>Total sum</th>
                    <th style="width: 20%;"></th>
                </tr>
            </thead>
            <tbody id="checks-table">
                {{#each checks}}
                <tr>
                    <td>{{this.check_number}}</td>
                    <td>{{this.empl_surname}}</td>
                    <td>{{formatDate this.print_date}}</td>
                    <td>{{this.sum_total}}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="checks/details/{{this.check_number}}" class="btn btn-primary btn-sm"
                                id="details">More
                                details...</a>
                            <a href="/checks/delete/{{this.check_number}}" class="btn btn-danger btn-sm"><i
                                    class="fa fa-times"></i></a>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>



    <script>
        function calculateTotalAmount() {
            var sum = 0;
            var amountElements = document.querySelectorAll("#checks-table td:nth-child(4)");

            amountElements.forEach(function (element) {
                var amount = parseFloat(element.textContent);
                if (!isNaN(amount)) {
                    sum += amount;
                }
            });

            document.getElementById("totalAmount").textContent = sum.toFixed(2);
        }
        document.addEventListener("DOMContentLoaded", function () {
            calculateTotalAmount();
        });

        var checksTable = document.getElementById("checks-table");
        checksTable.addEventListener("DOMSubtreeModified", function () {
            calculateTotalAmount();
        });

        var settingsDiv = document.getElementById("settings");
        settingsDiv.style.display = "none";

        function myFunction(x) {
            x.classList.toggle("change");
            var settingsDiv = document.getElementById("settings");

            // Toggle the visibility of the settings div
            if (settingsDiv.style.display === "none") {
                settingsDiv.style.display = "block";
            } else {
                settingsDiv.style.display = "none";
            }
        }

    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>